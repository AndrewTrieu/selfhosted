{
    order crowdsec first

    crowdsec {
        api_url http://crowdsec:8080
        api_key {env.CROWDSEC_API_KEY}
    }

    servers {
        trusted_proxies cloudflare
    }
}

# ===========================
# Global HTTP security headers
# ===========================
(sec_headers) {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy no-referrer
        -Server
    }
}

# ===========================
# Cloudflare DNS
# ===========================
(dns_cf) {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }
    log {
        output file {env.LOG_FILE}
        format json
    }
}

# ===========================
# Common configuration for all sites
# ===========================
(common_config) {
    import sec_headers
    import dns_cf
    crowdsec
    encode gzip zstd
}

# ===========================
# Root Domain
# Default landing page. Do something more useful here if desired.
# ===========================
{env.ROOT_DOMAIN} {
    import common_config
    respond 200 "Welcome to {env.ROOT_DOMAIN}!\n"
}

# ===========================
# Vaultwarden
# ===========================
{env.VAULT_DOMAIN} {
    import common_config
    reverse_proxy vaultwarden:80
}

# ===========================
# 2FAuth
# ===========================
{env.AUTH_DOMAIN} {
    import common_config
    reverse_proxy 2fauth:8000
}

# ===========================
# Filebrowser
# ===========================
{env.STORAGE_DOMAIN} {
    import common_config
    reverse_proxy filebrowser:80
}

# ===========================
# Adguard Home
# ===========================
{env.DNS_DOMAIN} {
    import common_config
    reverse_proxy adguard:3000
}

# ===========================
# WireGuard VPN
# Warning: Exposes your VPN management interface to the internet. Consider removing this section if not needed.
# ===========================
{env.VPN_DOMAIN} {
    import common_config
    reverse_proxy wg-easy:51821
}

# ===========================
# Gitea
# ===========================
{env.GIT_DOMAIN} {
    import common_config
    reverse_proxy gitea:3000
}

# ===========================
# 3X-UI
# ===========================
{env.XUI_DOMAIN} {
    import sec_headers
    import dns_cf
    encode gzip zstd

    # ---- X-UI admin panel ----
    route /admin* {
        crowdsec
        reverse_proxy host.docker.internal:2053
    }

    # ---- VLESS WebSocket ----
    route /ws* {
        @websockets {
            header Connection *Upgrade*
            header Upgrade websocket
        }
        reverse_proxy @websockets host.docker.internal:10000
        respond 403
    }

    respond 404
}

# ===========================
# Reality Domain - Block all traffic on HTTP/HTTPS
# ===========================
{env.REALITY_DOMAIN} {
    import sec_headers
    import dns_cf
    encode gzip zstd

    @any {
        protocol http
        protocol https
    }
    respond @any 444
}